<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tems.opr.common.dao.ExLinkMapper">

    <!--DEST_ORA..DNFTMS.TRI_VDSLANEHOUR_LOG-->
    <select id="selectVDSListView" parameterType="map" resultMap="vdsListMap">
        <![CDATA[
		  (SELECT VDS_ID, max(COL_DTM) AS COL_DTM, CAST(AVG(SPD) AS NUMERIC(8,0)) AS SPD, SUM(VOL) AS VOL FROM
		(SELECT TOP 8 VDS_ID, COL_DTM, SPD, VOL FROM TRI_VDSLANEHOUR_LOG
      ]]>
        <if test="vds_id_in != null and vds_id_in != ''">
            <![CDATA[
        WHERE VDS_ID IN (${vds_id_in})
        ]]>
        </if>
        <![CDATA[
        ORDER BY COL_DTM DESC) A GROUP BY VDS_ID)
         UNION ALL
        (SELECT VDS_ID, max(COL_DTM) AS COL_DTM, CAST(AVG(SPD) AS NUMERIC(8,0)) AS SPD, SUM(VOL) AS VOL FROM
		(SELECT TOP 8 VDS_ID, COL_DTM, SPD, VOL FROM TRI_VDSLANEDAY_LOG
      ]]>
        <if test="vds_id_in != null and vds_id_in != ''">
            <![CDATA[
        WHERE VDS_ID IN (${vds_id_in})
        ]]>
        </if>
        <![CDATA[
        ORDER BY COL_DTM DESC) A GROUP BY VDS_ID)
        ]]>
    </select>

    <resultMap id="vdsListMap" type="exlinkDTO">
        <result property="VDS_ID" column="VDS_ID"/>
        <result property="SPD" column="SPD"/>
        <result property="VOL" column="VOL"/>
    </resultMap>

    <!-- VMS 리스트 조회 -->
    <select id="selectVMSListView" parameterType="map" resultMap="vmsListMap">
        <![CDATA[
		  SELECT *
          ,CASE WHEN TRFICS_GRADE = 1 THEN '정체발생'
          WHEN TRFICS_GRADE = 2 THEN '지체발생'
          WHEN TRFICS_GRADE = 3 THEN '소통원활'
          END TRAFFIC_GRADE2
          FROM VW_VMSMSG a LEFT JOIN MST_HWSERVICESECT b
          ON A.SERVICE_SECT_ID = B.SERVICE_SECT_ID WHERE VMS_ID IS NOT NULL
              ]]>
        <if test="vms_id != null and vms_id != ''">
            <![CDATA[
          AND VMS_ID = #{vms_id}
          ]]>
        </if>
        <if test="vms_id_in != null and vms_id_in != ''">
            <![CDATA[
              AND VMS_ID in (${vms_id_in})
              ]]>
			order by a.VMS_ID, a.FORM_ID
        </if>
    </select>

    <resultMap id="vmsListMap" type="exlinkDTO">
        <result property="VMS_ID" column="VMS_ID"/>
        <result property="PHASE_SEQ" column="PHASE_SEQ"/>
        <result property="SUBFORM_ID" column="SUBFORM_ID"/>
        <result property="OBJECT_SEQ" column="OBJECT_SEQ"/>
        <result property="DISPLAY_PRD" column="DISPLAY_PRD"/>
        <result property="FORM_BACKGC_CD" column="FORM_BACKGC_CD"/>
        <result property="OBJECT_CNT" column="OBJECT_CNT"/>
        <result property="FORM_WIDTH" column="FORM_WIDTH"/>
        <result property="OBJECT_TP_CD" column="OBJECT_TP_CD"/>
        <result property="OBJECT_X" column="OBJECT_X"/>
        <result property="OBJECT_Y" column="OBJECT_Y"/>
        <result property="OBJECT_CTNT" column="OBJECT_CTNT"/>
        <result property="FONT_KIND_CD" column="FONT_KIND_CD"/>
        <result property="FONT_COLOR_CD" column="FONT_COLOR_CD"/>
        <result property="FONT_BOLD" column="FONT_BOLD"/>
        <result property="TRAFFIC_GRADE2" column="TRAFFIC_GRADE2"/>
        <result property="STR_NODE_NM" column="STR_NODE_NM"/>
        <result property="END_NODE_NM" column="END_NODE_NM"/>
        <result property="SERVICE_SECT_NM" column="SERVICE_SECT_NM"/>
        <result property="SERVICE_DIR_NM" column="SERVICE_DIR_NM"/>
    </resultMap>

    <!-- LCS 리스트 조회-->
    <select id="selectLCSListView" parameterType="map" resultMap="lcsListMap">
        SELECT * FROM VW_LCSMSG
        <if test="lcs_id_in != null and lcs_id_in != ''">
            <![CDATA[
		  WHERE LCS_ID in (${lcs_id_in})
			]]>
        </if>
        <if test="lcs_id != null and lcs_id != ''">
            WHERE LCS_ID = #{lcs_id}
        </if>
        ORDER BY LCS_ID, LANE_NO DESC, PHASE_SEQ
    </select>

    <resultMap id="lcsListMap" type="exlinkDTO">
        <result property="LCS_ID" column="LCS_ID"/>
        <result property="LANE_NO" column="LANE_NO"/>
        <result property="PHASE_SEQ" column="PHASE_SEQ"/>
        <result property="OBJECT_TP_CD" column="OBJECT_TP_CD"/>
        <result property="DISPLAY_TM" column="DISPLAY_TM"/>
        <result property="DISPLAY_TP_CD" column="DISPLAY_TP_CD"/>
        <result property="SYMBOL_ID_I" column="SYMBOL_ID"/>
        <result property="FONT_COLOR_CD" column="FONT_COLOR_CD"/>
        <result property="FONT_BACKG_COLOR_CD" column="FONT_BACKG_COLOR_CD"/>
        <result property="FONT_SIZE_I" column="FONT_SIZE"/>
        <result property="FONT_KIND_CD" column="FONT_KIND_CD"/>
        <result property="FONT_BOLD_YN" column="FONT_BOLD_YN"/>
        <result property="DISPLAY_TXT_MSG" column="DISPLAY_TXT_MSG"/>
        <result property="OPCODE_KIND" column="OPCODE_KIND"/>
    </resultMap>

    <!-- 기존에 DTO 로 result 됐는데 CD_NM 외에 쓰는 곳이 없음 -->
    <select id="selectCommonCode" parameterType="map" resultType="java.lang.String">
	    SELECT CD_NM FROM MST_CODE
	    WHERE USE_YN = 'Y'
		  AND div_id in ('CD0004','CD0008','CD0009','CD0010')
		  AND div_id = #{div_id}
		  AND cd_id = #{cd_id}
		  ORDER BY ord
    </select>

    <!-- TCS 차로이상정보 -->
    <select id="tcsConnSum_Temp" parameterType="hashmap" resultType="hashmap">
      	<![CDATA[
       		(SELECT PLZ_ID, LANE_NO AS LANE_NO_, CASE WHEN LANE_TYP LIKE '%2' THEN 'HPSS' ELSE 'TCS' END LANE_TYP
       				FROM PUBM_LANESTATE WHERE COMM_STAT != 'C' AND PLZ_ID = '006')
			 UNION
       		(SELECT PLZ_ID, LANE_NO AS LANE_NO_, CASE WHEN LANE_TYP LIKE '%2' THEN 'HPSS' ELSE 'TCS' END LANE_TYP
       		FROM PUBM_LANESTATE WHERE COMM_STAT != 'C' AND PLZ_ID = '007')
        ]]>
    </select>

    <!-- TCS 교통량이상정보 -->
    <select id="tcsReportSum" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
      		(SELECT '전일' AS DAYCOL, ISNULL(SUM(CAR_HND_CNT), 0) AS CAR_HND_CNT FROM PUBS_TIMETRIFFIC_O WHERE PLZ_ID = #{plz_id} AND WRK_DATE = #{yesterday_str}) UNION
		  	(SELECT '당일' AS DAYCOL, ISNULL(SUM(CAR_HND_CNT), 0) AS CAR_HND_CNT FROM PUBS_TIMETRIFFIC_O WHERE PLZ_ID = #{plz_id} AND WRK_DATE = #{today_str}) UNION
      		(SELECT '전월' AS DAYCOL, ISNULL(SUM(CAR_HND_CNT), 0) AS CAR_HND_CNT FROM PUBS_TIMETRIFFIC_O WHERE PLZ_ID = #{plz_id} AND WRK_DATE LIKE #{monthPre_str}) UNION
      		(SELECT '당월' AS DAYCOL, ISNULL(SUM(CAR_HND_CNT), 0) AS CAR_HND_CNT FROM PUBS_TIMETRIFFIC_O WHERE PLZ_ID = #{plz_id} AND WRK_DATE LIKE #{month_str})
        ]]>
    </select>
    
    <!-- VDS 조회 -->
    <select id="selectFVDSListView" parameterType="hashmap" resultType="hashmap">
    	SELECT 	VDS_ID
    	, 			CAST(SPD AS NUMERIC(8,0)) AS SPD
    	FROM 	TRI_VDSSPOT5MIN
    </select>

    <!-- 터널 안쪽의 CCTV 정보 조회 -->
    <select id="selectCctvInfo" parameterType="map" resultType="MstCctvDTO">
        select *
        from (select
                cctv_id,
                LATD,
                LONGD,
                CCTV_MILEPOST,
                case nm_mid
                when '오남'
                  then nm_prefix + ' ' + nm_mid + nm_suffix_1
                when '상계'
                  then nm_prefix + ' ' + nm_mid + nm_suffix_2
                end as tunnel_nm,
                cctv_type,
                direc,
                CAMERA_IP
              from (select
                      cctv_id,
                      cctv_type,
                      cctv_nm,
                      camera_ip,
                      latd,
                      longd,
                      CCTV_MILEPOST,
                      updown_div,
                      ord as direc,
                      substring(CCTV_NM, 1, 4)         as nm_prefix,
                      '#' + CONVERT(varchar(10), row_number()
                      over ( PARTITION BY MCD.CD_NM, substring(CCTV_NM, 1, 4)
                        order by CCTV_MILEPOST ))      as nm_suffix_1,
                      '#' + CONVERT(varchar(10), row_number()
                      over ( PARTITION BY MCD.CD_NM, substring(CCTV_NM, 1, 4)
                        order by CCTV_MILEPOST desc )) as nm_suffix_2,
                      substring(MCD.CD_NM, 1, 2)       as nm_mid
                    from MST_CCTV MCC
                      left join MST_CODE MCD
                        on MCC.UPDOWN_DIV = MCD.CD_ID
                           and MCD.DIV_ID = 'CD0001'
                    where MCC.USE_YN = 'Y' and MCC.TUNNEL_IN_YN = 'Y'
                   ) CCTV) T1
        where substring(tunnel_nm, 1,2) = #{tunnelNm}
        order by direc, CCTV_MILEPOST
    </select>

	<!-- TCS 교통량이상정보2 -->
	<select id="tcsReportSum2" parameterType="hashmap" resultType="exlinkDTO">
		<![CDATA[
      		(SELECT '전일' AS DAYCOL, ISNULL(SUM(CAR_HND_CNT), 0) AS CAR_HND_CNT FROM PUBS_TIMETRIFFIC_O WHERE PLZ_ID = #{plz_id} AND WRK_DATE = #{yesterday_str}) UNION
		  	(SELECT '당일' AS DAYCOL, ISNULL(SUM(CAR_HND_CNT), 0) AS CAR_HND_CNT FROM PUBS_TIMETRIFFIC_O WHERE PLZ_ID = #{plz_id} AND WRK_DATE = #{today_str}) UNION
      		(SELECT '전월' AS DAYCOL, ISNULL(SUM(CAR_HND_CNT), 0) AS CAR_HND_CNT FROM PUBS_TIMETRIFFIC_O WHERE PLZ_ID = #{plz_id} AND WRK_DATE LIKE #{monthPre_str}) UNION
      		(SELECT '당월' AS DAYCOL, ISNULL(SUM(CAR_HND_CNT), 0) AS CAR_HND_CNT FROM PUBS_TIMETRIFFIC_O WHERE PLZ_ID = #{plz_id} AND WRK_DATE LIKE #{month_str})
		]]>
    </select>

</mapper>