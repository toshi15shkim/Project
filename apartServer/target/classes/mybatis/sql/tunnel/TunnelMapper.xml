<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tems.opr.tunnel.dao.TunnelMapper">

    <!-- 터널에서 사용될 모니터링 주기 조회 -->
    <select id="selectMonTimeCodeView" parameterType="hashmap" resultType="hashmap">
		  SELECT DTL_CD_ID, MEMO FROM cmm_code
		  WHERE cd_id = 'MONITORING_TIME'
		  ORDER BY dtl_cd_id
    </select>
    
    <!-- 돌발 진행프로세스 -->
    <select id="planLibraryList" parameterType="hashmap" resultType="hashmap">
    SELECT DTL_EVENT_ID, CM.DTL_CD_NAME,EPC.TAG_DESC AS ACTIONS,PL.RISK_LEVEL, PL.PRIORITY, CMM.DN AS FACILITY, PL.SEQ, PL.PROC_TAG_NAME
      FROM PLAN_LIBRARY PL, CMM_CODE CM,EVENT_PROC_CATEG EPC,
          (SELECT DISTINCT CM.DTL_CD_ID AS DI,CM.DTL_CD_NAME AS DN FROM PLAN_LIBRARY PL , CMM_CODE CM
          WHERE PL.EQUIP_ID = CM.DTL_CD_ID AND CM.CD_ID='EQUIP_ID'
          <if test="event_id != null and event_id != ''">
            AND PL.EVENT_ID=#{event_id}
          </if>
          ) AS CMM
      WHERE PL.EVENT_ID = CM.DTL_CD_ID AND PL.EQUIP_ID = CMM.DI AND PL.PROC_TAG_NAME=EPC.TAG_NAME
          <if test="event_id != null and event_id != ''">
            AND PL.EVENT_ID=#{event_id}
          </if>
          <if test="occur_tag_name != null and occur_tag_name != ''">
            AND  PL.OCCUR_TAG_NAME=#{occur_tag_name}
          </if>
          <if test="risk_level != null and risk_level != ''">
            AND PL.RISK_LEVEL =#{risk_level}
            </if>
          <if test="equip_id != null and equip_id != ''">
            AND PL.EQUIP_ID = #{equip_id} 
            </if>
          <if test="proc_tag_name != null and proc_tag_name != ''">
            AND PL.PROC_TAG_NAME =#{proc_tag_name}
            </if>
          <if test="tunnel_id != null and tunnel_id != ''">
            AND PL.TUNNEL_ID=#{tunnel_id}
          </if>
          ORDER BY PL.EVENT_ID, PL.DTL_EVENT_ID, PL.PRIORITY, PL.RISK_LEVEL, CMM.DN
    </select>
    
    <!-- 상황전파관리 보기1 -->
    <select id="situationNotify" parameterType="hashmap" resultType="hashmap">
    SELECT TOP 1 SMS_MENUAL FROM SMS_MNG WHERE EVENT_ID = #{event_id} AND TUNNEL_ID = #{tunnel_id} ORDER BY CHANGE_DATE DESC
    </select>
    
    <!-- 알림정보 전체 게시물수 -->
  <select id="exlinkInformListTotal" parameterType="hashmap" resultType="int">
    SELECT count(*) AS CNT FROM INFORM_MNG
  </select>
  
  <!-- 알림정보 리스트 -->
  <select id="exlinkInformList" parameterType="hashmap" resultType="hashmap">
    SELECT  *
    FROM    (
            SELECT  TOP ${pageSize} *
            FROM    (
                    SELECT  TOP ${startRecord} CONVERT(VARCHAR(20), DATE, 120) AS infoDATE
                            , INFORM_NAME, INFORM_CONTENTS, INDEX_NUM
                        FROM  INFORM_MNG
                      ) AS DERIVEDTBL
            ORDER BY infoDATE DESC
          ) AS DERIVEDTBL
    ORDER BY infoDATE DESC
    </select>
    
    <!-- VDS 리스트 조회 -->
    <select id="exlinkVDSListView" parameterType="hashmap" resultType="hashmap">
      (SELECT VDS_ID, max(COL_DTM) AS COL_DTM, CAST(AVG(SPD) AS NUMERIC(8,0)) AS SPD, SUM(VOL) AS VOL FROM 
    (SELECT TOP 8 VDS_ID, COL_DTM, SPD, VOL FROM TRI_VDSLANEHOUR_LOG
      <if test="vds_id_in != null and vds_id_in != ''">
        WHERE VDS_ID IN (${vds_id_in})
      </if>
        ORDER BY COL_DTM DESC) A GROUP BY VDS_ID)
         UNION ALL
        (SELECT VDS_ID, max(COL_DTM) AS COL_DTM, CAST(AVG(SPD) AS NUMERIC(8,0)) AS SPD, SUM(VOL) AS VOL FROM 
    (SELECT TOP 8 VDS_ID, COL_DTM, SPD, VOL FROM TRI_VDSLANEDAY_LOG
      <if test="vds_id_in != null and vds_id_in != ''">
        WHERE VDS_ID IN (${vds_id_in})
      </if>
        ORDER BY COL_DTM DESC) A GROUP BY VDS_ID)
    </select>
    
    <!-- 돌발상황 CCTV 리스트 -->
    <select id="exlinkEventCCTV" parameterType="hashmap" resultType="hashmap">
    SELECT TOP 1 STREAMING_ADDR FROM
    (SELECT TOP 1 STREAMING_ADDR FROM MST_CCTV WHERE USE_YN = 'Y' AND TUNNEL_IN_YN = 'Y' AND UPDOWN_DIV = #{updown} AND CCTV_MILEPOST <![CDATA[<=]]> ${pos}
     ORDER BY CCTV_MILEPOST DESC) A UNION ALL
    SELECT TOP 1 STREAMING_ADDR FROM
    (SELECT TOP 1 STREAMING_ADDR FROM MST_CCTV WHERE USE_YN = 'Y' AND TUNNEL_IN_YN = 'Y' AND UPDOWN_DIV = #{updown} AND CCTV_MILEPOST > ${pos} ORDER BY CCTV_MILEPOST ASC) B
    </select>

</mapper>

