<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tems.opr.report.dao.ReportMapper">
	
	<!-- 돌발상황 리스트 조회 -->
	<select id="selectAccidentList" parameterType="hashmap" resultType="hashmap">	
	   SELECT * 
		FROM (	SELECT
					ROW_NUMBER() OVER (ORDER BY EO.OCCUR_DATE DESC) AS ROW_NUM
					, CONVERT(VARCHAR(20), EO.OCCUR_DATE, 120) AS OCCUR_DATE 
					, CONVERT(VARCHAR(20), EO.CONFIRM_DATE, 120) AS CONFIRM_DATE
					, EO.TAG_VAL
					, EO.MEMO
					, EO.USER_ID
					, EG.EQUIP_DESC
					, CONVERT(VARCHAR(20), EO.END_DATE, 120) AS END_DATE
					, CONVERT(VARCHAR(20), EO.FALSE_DATE, 120) AS FALSE_DATE
					, EC.EVENT_NAME
					, SUBSTRING( EOC.TAG_DESC, 6, LEN( EOC.TAG_DESC )) AS TAG_DESC
					, E.EQUIP_POS
				FROM
					dbo.EVENT_OCCUR AS EO
					INNER JOIN dbo.EVENT_OCC_CATEG AS EOC ON EO.TAG_NAME = EOC.TAG_NAME
					INNER JOIN dbo.EVENT_CATEG AS EC ON EOC.EVENT_ID = EC.EVENT_ID
					LEFT JOIN dbo.EVENT_EQUIP EG ON EO.TAG_NAME_FIRE=EG.TAG_NAME_ORIGIN
				    LEFT JOIN dbo.EQUIP E on EG.EQUIP_ID = E.EQUIP_ID AND EG.EQUIP_SEQ = E.EQUIP_SEQ
				WHERE
					EO.TAG_VAL IN (1,2)
					AND EO.TUNNEL_ID = #{tunnelId} 
					AND E.TUNNEL_ID = #{tunnelId}
		   			<if test="startDate != null and startDate != 'null' and startDate != ''">
			          AND EO.OCCUR_DATE <![CDATA[>=]]> #{startDate}
				    </if>  
					<if test="endDate != null and endDate != 'null' and endDate != ''">
			         and EO.OCCUR_DATE <![CDATA[<]]> DATEADD(DAY, 1,#{endDate})
				    </if>  
					<if test="eventId != null and eventId != ''">
			          and EC.EVENT_ID = #{eventId}
				    </if>  
					) AS BS
		WHERE
		 1 = 1
		<if test="endIndex != null and endIndex != ''">
			AND ROW_NUM <![CDATA[<]]> #{endIndex}
		</if>
		<if test="startIndex != null and startIndex != ''">
			AND ROW_NUM <![CDATA[>=]]> #{startIndex}
		</if>
	</select>

	<!-- 돌발상황 리스트 count -->
	<select id="selectAccidentListCnt" parameterType="hashmap" resultType="Integer">
		SELECT
			COUNT(*) AS CNT
		FROM
			dbo.EVENT_OCCUR AS EO
			INNER JOIN dbo.EVENT_OCC_CATEG AS EOC ON EO.TAG_NAME = EOC.TAG_NAME
			INNER JOIN dbo.EVENT_CATEG AS EC ON EOC.EVENT_ID = EC.EVENT_ID
			LEFT JOIN dbo.EVENT_EQUIP EG ON EO.TAG_NAME_FIRE=EG.TAG_NAME_ORIGIN
		    LEFT JOIN dbo.EQUIP E on EG.EQUIP_ID = E.EQUIP_ID AND EG.EQUIP_SEQ = E.EQUIP_SEQ
		WHERE
			EO.TAG_VAL IN (1,2)
			AND EO.TUNNEL_ID = #{tunnelId} 
			AND E.TUNNEL_ID = #{tunnelId}
   			<if test="startDate != null and startDate != 'null' and startDate != ''">
	          AND EO.OCCUR_DATE <![CDATA[>=]]> #{startDate}
		    </if>  
			<if test="endDate != null and endDate != 'null' and endDate != ''">
	         and EO.OCCUR_DATE <![CDATA[<]]> DATEADD(DAY, 1,#{endDate})
		    </if>  
			<if test="eventId != null and eventId != ''">
	          and EC.EVENT_ID = #{eventId}
		    </if>  
	</select>
	
	<!-- 설비 알람발생 정보 리스트 조회 -->
	<select id="selectAlarmList" parameterType="hashmap" resultType="hashmap">	
		 SELECT *, (SELECT EQUIP_GRP_NAME FROM EQUIP_GROUP WHERE EQUIP_GRP_ID = RS.EQUIP_GRP_ID AND TUNNEL_ID = RS.TUNNEL_ID) AS EQUIP_GRP_NAME
		  FROM (         
		      SELECT ROW_NUMBER() OVER (ORDER BY BS.LOGTIME DESC) AS ROW_NUM, 
		      		 CONVERT(VARCHAR(20), LOGTIME, 120) AS LOGTIME,
		      		 TAG_DESC,
		      		 TUNNEL_ID,
		      		 EQUIP_GRP_ID
		      FROM
		      (
				<if test="eventId != null and eventId != 'null' and eventId != ''">
					<if test="eventId == 'G000'">
			          select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from FRESH_DATA_D_${tunnelId} a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')
			          union all
			          select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from INST_DATA_D_${tunnelId} a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')          
			          union all
			          select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from FIRE_DATA_D_${tunnelId} a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')
			          union all
			         select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from ELEC_DATA_D_${tunnelId} a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')
			          union all
			          select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from ENV_DATA_D_${tunnelId} a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')
			          union all
			          select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from MACHINE_DATA_D_${tunnelId} a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')
			        </if>
					<if test="eventId == 'G001'">
			          select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from FRESH_DATA_D_${tunnelId} a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')
			          union all
			          select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from INST_DATA_D_${tunnelId} a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')
			        </if>
					<if test="eventId == 'G003'">
			          select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from FIRE_DATA_D_${tunnelId} a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')
			        </if>
					<if test="eventId == 'G004'">
			          select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from ELEC_DATA_D_${tunnelId} a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')
			        </if>
					<if test="eventId == 'G006'">
			          select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from ENV_DATA_D_${tunnelId} a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')
			          union all
			          select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from MACHINE_DATA_D_${tunnelId} a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')
			        </if>
			      </if>
			      ) AS BS WHERE LOGTIME IS NOT NULL 
					<if test="startDate != null and startDate != 'null' and startDate != ''">
			          AND BS.LOGTIME <![CDATA[>=]]> #{startDate}
				    </if>  
					<if test="endDate != null and endDate != 'null' and endDate != ''">
			         and BS.LOGTIME <![CDATA[<]]> DATEADD(DAY, 1,#{endDate})
				    </if>  
		) AS RS
		    WHERE
				 1 = 1
				<if test="endIndex != null and endIndex != ''">
					AND ROW_NUM <![CDATA[<]]> #{endIndex}
				</if>
				<if test="startIndex != null and startIndex != ''">
					AND ROW_NUM <![CDATA[>=]]> #{startIndex}
				</if>
	</select>
	
	<!-- 설비 알람발생 정보 리스트 count -->
	<select id="selectAlarmListCnt" parameterType="hashmap" resultType="Integer">
		      SELECT COUNT(*) AS CNT
		      FROM
		      (
				<if test="eventId != null and eventId != 'null' and eventId != ''">
					<if test="eventId == 'G000'">
			          select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from FRESH_DATA_D_${tunnelId} a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')
			          union all
			          select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from INST_DATA_D_T1 a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')          
			          union all
			          select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from FIRE_DATA_D_${tunnelId} a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')
			          union all
			         select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from ELEC_DATA_D_${tunnelId} a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')
			          union all
			          select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from ENV_DATA_D_${tunnelId} a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')
			          union all
			          select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from MACHINE_DATA_D_${tunnelId} a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')
			        </if>
					<if test="eventId == 'G001'">
			          select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from FRESH_DATA_D_${tunnelId} a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')
			          union all
			          select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from INST_DATA_D_${tunnelId} a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')
			        </if>
					<if test="eventId == 'G003'">
			          select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from FIRE_DATA_D_${tunnelId} a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')
			        </if>
					<if test="eventId == 'G004'">
			          select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from ELEC_DATA_D_${tunnelId} a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')
			        </if>
					<if test="eventId == 'G006'">
			          select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from ENV_DATA_D_${tunnelId} a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')
			          union all
			          select LOGTIME, TAG_DESC, TUNNEL_ID, EQUIP_GRP_ID
			          from MACHINE_DATA_D_${tunnelId} a, TAG_MASTER b
			          where (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '1' and b.ALARM_YN = 'Y' and b.REVERSE_YN is null)
			          or (a.TAG_NAME = b.TAG_NAME and a.D_VAL = '0' and b.ALARM_YN = 'Y' and b.REVERSE_YN = 'Y')
			        </if>
			      </if>
			      ) AS BS WHERE LOGTIME IS NOT NULL 
					<if test="startDate != null and startDate != 'null' and startDate != ''">
			          AND BS.LOGTIME <![CDATA[>=]]> #{startDate}
				    </if>  
					<if test="endDate != null and endDate != 'null' and endDate != ''">
			         and BS.LOGTIME <![CDATA[<]]> DATEADD(DAY, 1,#{endDate})
				    </if> 
	</select>
	
	
	<!-- 시설물 상태 리스트 조회 -->
	<select id="selectFacilityStateList" parameterType="hashmap" resultType="hashmap">		
		SELECT * 
		FROM (	SELECT
					ROW_NUMBER() OVER (ORDER BY FS.LOGTIME DESC) AS ROW_NUM,
					CONVERT(VARCHAR(20), FS.LOGTIME, 120)  AS LOGTIME,
					TM.TAG_DESC,
					CASE WHEN (FS.D_VAL = '1') THEN 'On'
					ELSE 'Off' 
					END  AS D_VAL,
					TM.EQUIP_ID,
					TM.TAG_NAME,
					TM.EQUIP_SEQ,
					EQ.EQUIP_NAME AS DTL_CD_NAME
				FROM
					${tableId} FS
				LEFT OUTER JOIN dbo.TAG_MASTER TM ON
					FS.TAG_NAME = TM.TAG_NAME
				LEFT OUTER JOIN EQUIP EQ ON
					TM.TUNNEL_ID = EQ.TUNNEL_ID
					AND TM.EQUIP_ID = EQ.EQUIP_SEQ
				WHERE
					TM.TUNNEL_ID IS NOT NULL
				<if test="startDate != null and startDate != 'null' and startDate != ''">
				  AND FS.LOGTIME <![CDATA[>=]]> #{startDate}
				</if>  
				<if test="endDate != null and endDate != 'null' and endDate != ''">
				 and FS.LOGTIME <![CDATA[<]]> DATEADD(DAY, 1,#{endDate})
				</if>  
			) AS BS
		WHERE
		 1 = 1
		<if test="endIndex != null and endIndex != ''">
			AND ROW_NUM <![CDATA[<]]> #{endIndex}
		</if>
		<if test="startIndex != null and startIndex != ''">
			AND ROW_NUM <![CDATA[>=]]> #{startIndex}
		</if>
	</select>

	<!-- 시설물 상태 count -->
	<select id="selectFacilityStateListCnt" parameterType="hashmap" resultType="Integer">
		SELECT
			COUNT(*) AS CNT
		FROM
			${tableId} FS
		LEFT OUTER JOIN dbo.TAG_MASTER TM ON
			FS.TAG_NAME = TM.TAG_NAME
		LEFT OUTER JOIN EQUIP EQ ON
			TM.TUNNEL_ID = EQ.TUNNEL_ID
			AND TM.EQUIP_ID = EQ.EQUIP_SEQ
		WHERE
			TM.TUNNEL_ID IS NOT NULL
		<if test="startDate != null and startDate != 'null' and startDate != ''">
		  AND FS.LOGTIME <![CDATA[>=]]> #{startDate}
		</if>  
		<if test="endDate != null and endDate != 'null' and endDate != ''">
		 and FS.LOGTIME <![CDATA[<]]> DATEADD(DAY, 1,#{endDate})
		</if>
	</select>
</mapper>

